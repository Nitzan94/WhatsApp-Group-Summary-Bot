# 🤖 WhatsApp Group Summary Bot - מדריך לClaude

## 📋 סקירת הפרויקט
בוט WhatsApp שמאזין לקבוצות, שומר הודעות ומייצר סיכומים חכמים באמצעות AI. הבוט תומך בתזמון אוטומטי, מחיקת הודעות ישנות, ואיסוף הודעות היסטוריות.

## 🎯 תכונות עיקריות
- 📊 מעקב אחר 123+ קבוצות WhatsApp
- 🤖 סיכומים חכמים עם Qwen 2.5 72B דרך OpenRouter
- ⏰ תזמון אוטומטי (cron) - 5 קבוצות פעילות
- 🧹 מחיקת הודעות ישנות אוטומטית (72 שעות)
- 📬 איסוף הודעות היסטוריות בפקודת !today
- 🎮 פקודות מרחוק מקבוצת ניצן

## 🏗️ ארכיטקטורת המערכת

### קבצים עיקריים
```
src/
├── bot.js                    # קובץ ראשי - לוגיקת הבוט
├── database/
│   ├── DatabaseManager.js    # ניהול SQLite
│   └── schema.sql            # סכמת הנתונים
└── services/
    ├── SchedulerService.js   # מערכת תזמונים
    └── SummaryService.js     # יצירת סיכומים עם AI
```

### בסיס נתונים (SQLite)
- **messages** - שמירת כל ההודעות
- **groups** - רשימת קבוצות ותזמונים
- **summaries** - היסטוריית סיכומים
- **bot_stats** - סטטיסטיקות יומיות

## 🔧 הגדרות חשובות

### משתני סביבה (.env)
```bash
OPENROUTER_API_KEY=sk-or-v1-xxx  # API key לOpenRouter
OPENROUTER_MODEL=qwen/qwen-2.5-72b-instruct:free
DB_PATH=./data/messages.db
DEFAULT_SCHEDULE=0 16 * * *  # ברירת מחדל: 16:00 כל יום
```

### קבוצת ניצן
- **ID:** `972546262108-1556219067@g.us`
- **תפקיד:** קבלת כל הסיכומים ופקודות ניהול

## 📱 פקודות זמינות

### פקודות בסיסיות (מכל קבוצה)
- `!status` - מצב הבוט ומספר הודעות
- `!summary` - סיכום הודעות חדשות
- `!today` - סיכום כל הודעות מהיום
- `!test` - בדיקת חיבור לAI
- `!help` - רשימת פקודות

### פקודות מתקדמות (רק מקבוצת ניצן)
- `!today [שם קבוצה]` - סיכום יומי לקבוצה אחרת
- `!summary [שם קבוצה]` - סיכום לקבוצה אחרת
- `!list` - רשימת כל הקבוצות
- `!search [טקסט]` - חיפוש קבוצות
- `!schedules` - רשימת תזמונים פעילים
- `!schedule [קבוצה] [זמן]` - הגדרת תזמון
- `!unschedule [קבוצה]` - ביטול תזמון

## 🔄 תהליכי עבודה

### איסוף הודעות
1. **זמן אמת** - שמירת כל הודעה שמגיעה
2. **היסטוריה באתחול** - איסוף הודעות שהוחמצו מ-5 קבוצות מתוזמנות
3. **היסטוריה ב-!today** - איסוף הודעות מהיום לפני יצירת סיכום

### יצירת סיכום
1. איסוף הודעות מהמסד/היסטוריה
2. שליחה ל-AI (OpenRouter)
3. עיבוד וקבלת סיכום מובנה
4. שמירה במסד נתונים
5. שליחה לקבוצת ניצן

### תזמון אוטומטי
- **16:00** - סיכום יומי ל-5 קבוצות
- **02:00** - מחיקת הודעות ישנות (72+ שעות)

## 🐛 בעיות ידועות ופתרונות

### 1. הבוט לא מקבל היסטוריה
**בעיה:** `fetchMessageHistory` לא תמיד עובד
**פתרון זמני:** הבוט שומר הודעות בזמן אמת, היסטוריה עובדת רק אם יש הודעות קודמות במסד

### 2. בעיית זמנים UTC vs Local
**בעיה:** סיכומים מהיום מביאים תאריך לא נכון
**פתרון:** תוקן ב-`getTodaysMessages` - משתמש בזמן מקומי

### 3. link-preview-js חסר
**בעיה:** Warning על מודול חסר
**השפעה:** אין - לא משפיע על פעולת הבוט

## 🚀 הרצה ותחזוקה

### הפעלה
```bash
node src/bot.js
```

### גיבויים
תיקיית גיבויים: `/home/nitza/Projects/botbot-backup-v3.0/`

### עדכון תלותות
```bash
npm update
npm audit fix
```

## 📊 מעקב וניטור

### לוגים
- **מיקום:** `logs/bot.log`
- **רמות:** info, debug, error
- **ניקוי:** אוטומטי אחרי 7 ימים

### סטטיסטיקות
- הודעות שעובדו
- סיכומים שנוצרו
- שגיאות
- זמן פעילות

## 💡 טיפים לפיתוח

### הוספת קבוצה לתזמון
```javascript
!schedule "שם הקבוצה" "יומי 16:00"
```

### בדיקת הודעות במסד
```bash
sqlite3 data/messages.db "SELECT COUNT(*) FROM messages WHERE group_id='GROUP_ID'"
```

### ניקוי ידני של הודעות ישנות
```bash
sqlite3 data/messages.db "DELETE FROM messages WHERE timestamp < datetime('now', '-72 hours')"
```

## 🔐 אבטחה
- אין שמירת מידע רגיש בקוד
- API keys ב-.env בלבד
- הרשאות מוגבלות לפקודות ניהול
- מחיקה אוטומטית של הודעות ישנות

## 📝 הערות חשובות
1. **הבוט לא צריך לרוץ 24/7** - יכול לאסוף היסטוריה בהפעלה
2. **מגבלת API** - 50 הודעות לקבוצה באיסוף היסטוריה
3. **זמן ישראל** - כל הזמנים מחושבים לפי Asia/Jerusalem
4. **קבוצת ניצן** - חובה להגדיר לקבלת סיכומים

## 🎉 גרסה נוכחית: v3.0
- תאריך: 30.8.2025
- מפתח: ניצן (בעזרת Claude)
- רישיון: MIT